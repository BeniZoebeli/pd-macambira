#!/bin/sh

HOSTNAME=`hostname | sed 's|\([a-zA-Z0-9-]\)\..*|\1|'`
SYSTEM=`uname -s`
DATE=`date +%Y-%m-%d`
TIME=`date +%H.%M.%S`
SCRIPT=`echo $0| sed 's|.*/\(.*\)|\1|g'`

RECIPIENT=pd-cvs@iem.at

run_build_script ()
{
	 distro=$1

	 LOGFILE=/home/pd/logs/${DATE}_${TIME}_${SYSTEM}_${HOSTNAME}_${distro}_${SCRIPT}.txt
	 touch ${LOGFILE} 

	 sh /home/pd/auto-build/${distro}/scripts/auto-build/${distro}-auto-builder.sh >> $LOGFILE 2>&1

	 rsync -a ${LOGFILE} rsync://128.238.56.50/upload/${DATE}/logs/

# send status report if something failed
	 completion_test=`tail -1 ${LOGFILE}`
	 if [ "x${completion_test}" != "xSUCCESS" ]; then
		  SUBJECT="autobuild: $distro $HOSTNAME $DATE $TIME"
		  tail -200 ${LOGFILE} | mail -s "${SUBJECT}" ${RECIPIENT}
	 fi
}

run_build_script pd-main
run_build_script pd-extended
#run_build_script pd-devel


